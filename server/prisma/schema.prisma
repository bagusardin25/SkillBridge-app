generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  password        String?          // Optional for OAuth users
  name            String?
  role            Role             @default(USER)
  tier            SubscriptionTier @default(FREE)
  subscriptionEnd DateTime?
  isVerified      Boolean          @default(false)
  verifyToken     String?
  verifyExpires   DateTime?
  resetToken      String?
  resetExpires    DateTime?
  bio             String?
  location        String?
  jobRole         String?
  xp              Int              @default(0)
  level           Int              @default(1)
  avatarUrl       String?
  currentStreak   Int              @default(0)
  longestStreak   Int              @default(0)
  lastActiveDate  DateTime?
  totalLearningMinutes Int         @default(0)
  
  // OAuth fields
  provider        String?          // "google", "github", "email"
  providerId      String?          // OAuth provider user ID
  
  projects        Project[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Project {
  id        String    @id @default(cuid())
  title     String
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  roadmaps  Roadmap[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Roadmap {
  id        String   @id @default(cuid())
  title     String
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  nodes     Json     // Store React Flow nodes as JSON
  edges     Json     // Store React Flow edges as JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QuizResult {
  id             String   @id @default(cuid())
  roadmapId      String
  nodeId         String   // ID node di roadmap
  userId         String
  score          Int      // Jumlah benar (0-5)
  totalQuestions Int      // Total soal (5)
  passed         Boolean  // score >= 90%
  answers        Json     // Array jawaban user
  questions      Json     // Soal yang digenerate (untuk review)
  timeTaken      Int?     // Waktu pengerjaan dalam detik
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([roadmapId, nodeId, userId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  projectId String
  nodeId    String?  // null untuk chat umum, filled untuk chat per node
  role      String   // "user" atau "assistant"
  content   String   @db.Text
  createdAt DateTime @default(now())

  @@index([projectId, nodeId])
}
